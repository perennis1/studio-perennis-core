generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/**
 * ===================== ENUMS =====================
 */

enum PostStatus {
  DRAFT
  PUBLISHED
}

enum CourseStatus {
  DRAFT
  PUBLISHED
}

enum VariantType {
  PDF
  HARDCOPY
}

enum FulfillmentType {
  IN_HOUSE
  POD
  HYBRID
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
  COD_PENDING
  COD_PAID
}

enum DeliveryStatus {
  PENDING
  PACKED
  SHIPPED
  DELIVERED
}

enum ReadingMode {
  FREE
  GUIDED
  INQUIRY
}

enum ReadingSessionState {
  ACTIVE
  GATE_BLOCKED
  COMPLETED
  ABANDONED
  LOCKED
}

enum ShipmentStatus {
  PENDING // created, not shipped
  PACKED
  SHIPPED
  DELIVERED
  RETURNED
  CANCELLED
}

enum BookType {
  CURRICULUM
  GENERAL
}

enum ReflectionQuality {
  OK
  LOW_EFFORT
  REPETITIVE
}

enum PostType {
  REFLECTION
  ESSAY
  ANNOUNCEMENT
}

/**
 * ===================== USER =====================
 */

model User {
  id                   Int                   @id @default(autoincrement())
  email                String                @unique
  password             String
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  lessonTimelineEvents LessonTimelineEvent[]
  lessonProgresses     LessonProgress[]
  name                 String?
  avatar               String?
  tagline              String?
  isAdmin              Boolean               @default(false)

  xp    Int @default(0)
  level Int @default(1)

  profile ProfileReadModel?

  posts            Post[]
  reflections      Reflection[]
  comments         Comment[]         @relation("UserComments")
  likes            Like[]
  bookmarks        Bookmark[]
  postReactions    PostReaction[]
  commentReactions CommentReaction[]

  lessonLikes     LessonLike[]
  lessonBookmarks LessonBookmark[]

  lessonEnrollments LessonEnrollment[]
  activities        UserActivity[]
  courseEnrollments CourseEnrollment[]

  authoredCourses Course[]

  purchases      Purchase[]         @relation("UserPurchases")
  courseAccesses UserCourseAccess[] @relation("UserCourseAccesses")

  reflectionAnswers ReflectionAnswer[]

  libraryEntries  LibraryEntry[]
  bookOrders      BookOrder[]
  readingSessions ReadingSession[]
  returnEntries   ReturnEntry[]
  inquiryThreads  InquiryThread[]
    learningEvents LearningEvent[]
     bookReadingSignals BookReadingSignal[]
}

/**
 * ===================== PROFILE =====================
 */

model ProfileReadModel {
  userId Int  @id
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  currentInquiry    String?
  currentlyStudying String?
  lastActiveInquiry String?

  updatedAt DateTime @updatedAt
}

/**
 * ===================== POSTS =====================
 */

model Reflection {
  id            Int       @id @default(autoincrement())
  userId        Int
  lessonId      Int
  text          String
  contentLength Int
  revisionCount Int       @default(0)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  deleted       Boolean   @default(false)
  deletedAt     DateTime?

  user   User   @relation(fields: [userId], references: [id])
  lesson Lesson @relation(fields: [lessonId], references: [id])

  @@unique([userId, lessonId])
}

model Post {
  id        Int        @id @default(autoincrement())
  title     String
  slug      String     @unique
  content   String
  excerpt   String?
  status    PostStatus @default(DRAFT)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  publishedAt    DateTime?
  deleted        Boolean        @default(false)
  category       String?
  views          Int            @default(0)
  likesCount     Int            @default(0)
  bookmarksCount Int            @default(0)
  commentsCount  Int            @default(0)
  type           PostType       @default(REFLECTION)
  authorId       Int
  author         User           @relation(fields: [authorId], references: [id])
  deletedAt      DateTime?
  likes          Like[]
  bookmarks      Bookmark[]
  comments       Comment[]      @relation("PostComments")
  postReactions  PostReaction[]
}

model Like {
  id     Int @id @default(autoincrement())
  userId Int
  postId Int

  user User @relation(fields: [userId], references: [id])
  post Post @relation(fields: [postId], references: [id])

  @@unique([userId, postId])
}

model Bookmark {
  id     Int @id @default(autoincrement())
  userId Int
  postId Int

  user User @relation(fields: [userId], references: [id])
  post Post @relation(fields: [postId], references: [id])

  @@unique([userId, postId])
}

model Comment {
  id        Int      @id @default(autoincrement())
  userId    Int
  targetId  Int?
  parentId  Int?
  content   String
  createdAt DateTime @default(now())

  user    User      @relation("UserComments", fields: [userId], references: [id])
  post    Post?     @relation("PostComments", fields: [targetId], references: [id])
  parent  Comment?  @relation("Replies", fields: [parentId], references: [id])
  replies Comment[] @relation("Replies")

  reactions CommentReaction[]
}

model CommentReaction {
  id        Int      @id @default(autoincrement())
  userId    Int
  commentId Int
  type      String
  createdAt DateTime @default(now())

  user    User    @relation(fields: [userId], references: [id])
  comment Comment @relation(fields: [commentId], references: [id])

  @@unique([userId, commentId, type])
}

model PostReaction {
  id     Int    @id @default(autoincrement())
  userId Int
  postId Int
  emoji  String

  user User @relation(fields: [userId], references: [id])
  post Post @relation(fields: [postId], references: [id])

  @@unique([userId, postId, emoji])
}

/**
 * ===================== COURSES =====================
 */

model Course {
  id             Int                @id @default(autoincrement())
  title          String
  slug           String             @unique
  summary        String?
  level          String?
  durationMin    Int?
  thumbnail      String? // ✅ ADD THIS
  status         CourseStatus       @default(DRAFT)
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  lessons        Lesson[]
  enrollments    CourseEnrollment[]
  authorId       Int
  author         User               @relation(fields: [authorId], references: [id])
  purchases      Purchase[]         @relation("CoursePurchases")
  courseAccesses UserCourseAccess[] @relation("CourseAccesses")
}

model LessonEnrollment {
  id          Int       @id @default(autoincrement())
  userId      Int
  lessonId    Int
  completed   Boolean   @default(false)
  completedAt DateTime?

  user   User   @relation(fields: [userId], references: [id])
  lesson Lesson @relation(fields: [lessonId], references: [id])

  @@unique([userId, lessonId])
  @@index([userId, completedAt])
}

model CourseEnrollment {
  id       Int @id @default(autoincrement())
  userId   Int
  courseId Int

  enrolledAt DateTime @default(now())

  user   User   @relation(fields: [userId], references: [id])
  course Course @relation(fields: [courseId], references: [id])

  @@unique([userId, courseId])
}

model Lesson {
  id             Int                   @id @default(autoincrement())
  title          String
  slug           String
  body           String?
  videoUrl       String?
  order          Int
  courseId       Int
  activities     UserActivity[] // ← ADD THIS
  durationSec    Int? // derived or manual
  thumbnail      String?
  course         Course                @relation(fields: [courseId], references: [id])
  enrollments    LessonEnrollment[]
  likes          LessonLike[]
  bookmarks      LessonBookmark[]
  isPreview      Boolean               @default(false)
  timeline       Json? // [{ time: 120, label: "Derivatives intro" }]
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt
  reflections    Reflection[]
  timelineEvents LessonTimelineEvent[]
  progress       LessonProgress[]

  @@unique([courseId, slug])
}

model LessonLike {
  id       Int @id @default(autoincrement())
  userId   Int
  lessonId Int

  user   User   @relation(fields: [userId], references: [id])
  lesson Lesson @relation(fields: [lessonId], references: [id])

  @@unique([userId, lessonId])
}

model LessonBookmark {
  id       Int @id @default(autoincrement())
  userId   Int
  lessonId Int

  user   User   @relation(fields: [userId], references: [id])
  lesson Lesson @relation(fields: [lessonId], references: [id])

  @@unique([userId, lessonId])
}

/**
 * ===================== PURCHASES =====================
 */

model Purchase {
  id        Int      @id @default(autoincrement())
  userId    Int
  courseId  Int
  amount    Int
  currency  String
  status    String
  createdAt DateTime @default(now())

  user   User   @relation("UserPurchases", fields: [userId], references: [id])
  course Course @relation("CoursePurchases", fields: [courseId], references: [id])

  userCourseAccess UserCourseAccess?
}

model UserCourseAccess {
  id               Int      @id @default(autoincrement())
  userId           Int
  courseId         Int
  sourcePurchaseId Int      @unique
  grantedAt        DateTime @default(now())

  user     User     @relation("UserCourseAccesses", fields: [userId], references: [id])
  course   Course   @relation("CourseAccesses", fields: [courseId], references: [id])
  purchase Purchase @relation(fields: [sourcePurchaseId], references: [id])

  @@unique([userId, courseId])
}

/**
 * ===================== BOOKS =====================
 */

model Book {
  id         Int      @id @default(autoincrement())
  title      String
  slug       String   @unique
  author     String?
  pages      Int?
  coverImage String?
  pdfPath    String
  type       BookType
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  variants        BookVariant[]
  libraryEntries  LibraryEntry[]
  readingSessions ReadingSession[]
  segments        BookSegment[]
  gates           ReflectionGate[]
  returnEntries   ReturnEntry[]
  bookOrderItems  BookOrderItem[]
  readingWindows  ReadingWindow[]
    readingSignals BookReadingSignal[]
}

model BookVariant {
  id              String          @id @default(cuid())
  bookId          Int
  type            VariantType
  sku             String          @unique
  pricePaise      Int
  fulfillmentType FulfillmentType @default(IN_HOUSE)

  book           Book            @relation(fields: [bookId], references: [id])
  inventory      Inventory[]
  bookOrderItems BookOrderItem[]

  @@index([bookId])
}

model Warehouse {
  id      String  @id @default(cuid())
  name    String
  city    String?
  country String? @default("IN")

  inventory Inventory[]
}

model Inventory {
  id          String @id @default(cuid())
  variantId   String
  warehouseId String
  onHand      Int    @default(0)
  reserved    Int    @default(0)

  variant   BookVariant @relation(fields: [variantId], references: [id])
  warehouse Warehouse   @relation(fields: [warehouseId], references: [id])

  @@unique([variantId, warehouseId])
}

model LibraryEntry {
  id         Int         @id @default(autoincrement())
  userId     Int
  bookId     Int
  format     VariantType
  acquiredAt DateTime    @default(now())

  user User @relation(fields: [userId], references: [id])
  book Book @relation(fields: [bookId], references: [id])

  @@unique([userId, bookId])
}

/**
 * ===================== ORDERS =====================
 */

model BookOrder {
  id        Int      @id @default(autoincrement())
  userId    Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  paymentInitiatedAt DateTime // ⬅ ADD (monotonic clock)
  expiredAt          DateTime? // ⬅ ADD (idempotency)

  paymentStatus  PaymentStatus  @default(PENDING)
  deliveryStatus DeliveryStatus @default(PENDING)

  contactName  String
  contactEmail String
  phone        String?

  shippingAddress String?
  shippingCity    String?
  shippingState   String?
  shippingZip     String?
  shippingCountry String?

  totalAmountPaise Int
  currency         String @default("INR")

  user        User                  @relation(fields: [userId], references: [id])
  items       BookOrderItem[]
  payments    Payment[]
  transitions BookOrderTransition[]
  shipment    Shipment? // ← ADD THIS

  @@index([paymentStatus, paymentInitiatedAt])
}

model BookOrderItem {
  id             Int         @id @default(autoincrement())
  orderId        Int
  bookId         Int
  variantId      String // ⬅ ADD (FK)
  format         VariantType
  unitPricePaise Int
  quantity       Int         @default(1)

  order BookOrder @relation(fields: [orderId], references: [id])
  book  Book      @relation(fields: [bookId], references: [id])

  variant BookVariant @relation(fields: [variantId], references: [id])

  @@index([orderId])
  @@index([variantId])
}

model Payment {
  id          String        @id @default(cuid())
  bookOrderId Int
  provider    String
  providerRef String
  status      PaymentStatus
  amountPaise Int
  createdAt   DateTime      @default(now())

  bookOrder BookOrder @relation(fields: [bookOrderId], references: [id])

  @@unique([provider, providerRef])
}

model PaymentEvent {
  provider  String
  eventId   String
  payload   Json?
  createdAt DateTime @default(now())

  @@id([provider, eventId])
}

model BookOrderTransition {
  id             String   @id @default(cuid())
  bookOrderId    Int
  field          String
  fromValue      String
  toValue        String
  idempotencyKey String   @unique
  createdAt      DateTime @default(now())

  bookOrder BookOrder @relation(fields: [bookOrderId], references: [id])
}

/**
 * ===================== READING =====================
 */

model ReadingSession {
  id     String              @id @default(cuid())
  userId Int
  bookId Int
  mode   ReadingMode
  state  ReadingSessionState @default(ACTIVE)

  lastSeenPage        Int?
  furthestAllowedPage Int?

  startedAt    DateTime @default(now())
  lastActiveAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])
  book Book @relation(fields: [bookId], references: [id])

  @@index([userId, bookId])
}

model BookSegment {
  id        String  @id @default(cuid())
  bookId    Int
  order     Int
  title     String?
  startPage Int?
  endPage   Int?

  book Book @relation(fields: [bookId], references: [id])

  @@unique([bookId, order])
}

model ReflectionGate {
  id         String @id @default(cuid())
  bookId     Int
  pageNumber Int
  question   String
  minLength  Int    @default(50)

  book        Book               @relation(fields: [bookId], references: [id])
  answers     ReflectionAnswer[]
  assignments GateAssignment[]
}

model ReflectionAnswer {
  id      String            @id @default(cuid())
  gateId  String
  userId  Int
  text    String
  quality ReflectionQuality @default(OK)
  flagged Boolean           @default(false)

  inquiryThreadId String?
  inquiryThread   InquiryThread? @relation(fields: [inquiryThreadId], references: [id])

  gate ReflectionGate @relation(fields: [gateId], references: [id])
  user User           @relation(fields: [userId], references: [id])

  @@unique([gateId, userId])
}

model ReturnEntry {
  id             String    @id @default(cuid())
  userId         Int
  bookId         Int
  reason         String
  unresolvedNote String?
  revisitAt      DateTime?
  createdAt      DateTime  @default(now())

  user User @relation(fields: [userId], references: [id])
  book Book @relation(fields: [bookId], references: [id])

  @@unique([userId, bookId])
}

model UserActivity {
  id        Int      @id @default(autoincrement())
  userId    Int
  type      String
  createdAt DateTime @default(now())

  lessonId Int?
  lesson   Lesson? @relation(fields: [lessonId], references: [id])

  user User @relation(fields: [userId], references: [id])

  @@index([userId, createdAt])
}

model LearningEvent {
  id        String   @id @default(cuid())
  userId    Int

  surfaceType String // "BOOK" | "LESSON"
  surfaceId   Int    // bookId OR lessonId

  eventType String
  /*
    BOOK_PAGE_OPEN
    BOOK_PAGE_PROGRESS
    BOOK_GATE_REFLECTION

    LESSON_OPEN
    LESSON_PROGRESS
    LESSON_TIMELINE_SEEK
    LESSON_REFLECTION
    LESSON_COMPLETE
  */

  position Int?   // pageNumber OR second
  delta    Int?   // pages/sec since last event

  qualityScore Int? // computed later (Phase 9+)
  metadata     Json?

  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([userId, createdAt])
  @@index([surfaceType, surfaceId])
  @@index([eventType])
}


model EventLedger {
  id         String   @id @default(cuid())
  entityType String // ORDER | PAYMENT | INVENTORY | LIBRARY | SHIPMENT
  entityId   String // orderId / paymentId / variantId etc
  eventType  String // CREATED | RESERVED | RELEASED | PAID | FAILED | EXPIRED
  actorType  String // USER | SYSTEM | ADMIN | GATEWAY
  actorId    Int? // userId if applicable
  payload    Json?
  createdAt  DateTime @default(now())

  @@index([entityType, entityId])
  @@index([eventType])
}

model Shipment {
  id String @id @default(cuid())

  orderId Int       @unique
  order   BookOrder @relation(fields: [orderId], references: [id])

  status ShipmentStatus @default(PENDING)

  addressSnapshot Json

  carrier  String?
  tracking String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model AppSetting {
  id Int @id @default(autoincrement())

  siteName     String?
  tagline      String?
  supportEmail String?

  maintenanceMode Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ActivityEvent {
  id         Int      @id @default(autoincrement())
  userId     Int
  entityType String // "BOOK" | "COURSE" | "LESSON"
  entityId   Int
  action     String // STARTED | CONTINUED | COMPLETED | REFLECTION | ACCESS_REVOKED
  metadata   Json?
  createdAt  DateTime @default(now())

  @@index([userId, createdAt])
}

model GateAssignment {
  id        String   @id @default(cuid())
  gateId    String
  cohortId  Int? // null = global
  active    Boolean  @default(true)
  createdAt DateTime @default(now())

  gate ReflectionGate @relation(fields: [gateId], references: [id])

  @@unique([gateId, cohortId])
}

model CurriculumStep {
  id       String  @id @default(cuid())
  cohortId Int? // null = global curriculum
  order    Int
  type     String // BOOK_SEGMENT | REFLECTION_GATE | LESSON
  refId    String // segmentId / gateId / lessonId
  active   Boolean @default(true)

  createdAt DateTime @default(now())

  @@unique([cohortId, order])
}

model ReadingWindow {
  id       String   @id @default(cuid())
  bookId   Int
  cohortId Int? // null = global
  startAt  DateTime
  endAt    DateTime
  active   Boolean  @default(true)

  book Book @relation(fields: [bookId], references: [id])

  @@index([bookId, cohortId])
}

model InquiryThread {
  id     String  @id @default(cuid())
  userId Int
  title  String // short human-readable theme
  open   Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user              User               @relation(fields: [userId], references: [id])
  reflectionAnswers ReflectionAnswer[]

  @@index([userId, open])
}

model LessonTimelineEvent {
  id        Int      @id @default(autoincrement())
  userId    Int
  lessonId  Int
  second    Int
  label     String?
  createdAt DateTime @default(now())

  user   User   @relation(fields: [userId], references: [id])
  lesson Lesson @relation(fields: [lessonId], references: [id])

  @@index([userId, lessonId])
}

model LessonProgress {
  id              Int      @id @default(autoincrement())
  userId          Int
  lessonId        Int
  lastPositionSec Int
  maxPositionSec  Int
  watchedSeconds  Int      @default(0)
  updatedAt       DateTime @updatedAt
  createdAt       DateTime @default(now())

  user   User   @relation(fields: [userId], references: [id])
  lesson Lesson @relation(fields: [lessonId], references: [id])

  @@unique([userId, lessonId])
}

model LessonEngagementSignal {
  id        Int @id @default(autoincrement())
  userId    Int
  lessonId  Int

  watchRatio            Float?
  completionConfidence  Float?
  rewatchIntensity      Float?
  timelineUsageRate     Float?

  computedAt DateTime @default(now())

  @@unique([userId, lessonId])
}
model BookReadingSignal {
  id        Int @id @default(autoincrement())

  userId Int
  bookId Int

  totalSessions        Int
  totalPagesRead       Int
  avgSessionDepth      Float?
  returnFrequency      Float?
  gateFriction         Float?
  reflectionDensity    Float?

  computedAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
  book Book @relation(fields: [bookId], references: [id])

  @@unique([userId, bookId])
}
model CurriculumSignal {
  id                Int      @id @default(autoincrement())

  curriculumType    String   // "COURSE" | "BOOK"
  curriculumId      Int

  nodeIndex         Int      // lesson order or page order

  avgEngagement     Float?
  avgReflectionLen  Float?
  frictionRate      Float?
  completionRate    Float?

  sampleSize        Int

  createdAt         DateTime @default(now())

  @@index([curriculumType, curriculumId])
}
